name: Release framework

on:
  pull_request:
    types:
      - closed
        
jobs:
  release_framework:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    
    - name: Setup gem
      uses: appier/appier-ios/.github/actions/install_gem_dependencies@master

    - name: Github release
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        bundle exec fastlane release
        
    - name: Deploy pods framework
      run: |
        bundle exec fastlane pods_framework
        
    - name: Deploy pods extension framework
      run: |
        bundle exec fastlane pods_extension_framework

    - name: Enable Build app with release framework workflow
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/appier/appier-ios-automation-test-app/actions/workflows/build_app_from_release_sources.yml/enable"
          
  release_fail_message:
    needs: [release_framework]
    if: ${{ always() && contains(needs.*.result, 'failure') }}
    uses: appier/appier-ios-githubactions-test/.github/workflows/Send_message_to_slack.yml@master
    secrets: inherit
    with:
      notify_user_group: '${{ secrets.SLACK_IOS_USER_GROUP }}'
      message: ":alert_party: Release framework fail !!"
